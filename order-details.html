<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>订单详情</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <script>
        document.documentElement.style.fontSize = window.innerWidth / 7.5 + 'px';
    </script>
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" href="css/swiper-3.4.2.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/details.css">
    <style>
        .hintTime {
            font-size: .24rem;
        }

        .commonStyle span {
            font-size: .24rem;
        }
    </style>

    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function(){
            _vds.push(['setAccountId', 'aeea6ff5baedd18e']);
            (function() {
                var vds = document.createElement('script');
                vds.type='text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
    <script type='text/javascript' src='https://assets.growingio.com/sdk/wx/vds-wx-plugin.js'></script>
</head>

<body class="bodyStyle">
    <div style="position:absolute;top:0;left:0;right:0;bottom:0;overflow-x:hidden;">
        <div class="common-header">
            <div class="icon-back" onclick="mineInfoBack()">
                <a href="#"></a>
            </div>
            <div class="common-title">
                订单详情
            </div>
        </div>
        <div class="contentWrapper">
        </div>
        <div id="orderRulesContent">
            <div class="common-header">
                <div class="icon-back" id="backLast">
                    <a></a>
                </div>
                <div class="common-title">
                    预定须知
                </div>
            </div>
            <p class="main">
                一、预定协议：</br>1）请不要将贵重物品及自用应急药品放在托运行李中，以免丢失。</br>2）请您在旅游期间遵守当地的法律法规，注意自己的人身和财产安全。</br>3）根据目的国使馆要求，旅游者在参团期间，不得脱离团队。</br>4）景点首道门票是指景区收取的，进入景区的首道门票。不包括该景区内单独收费的小景区、或景区内需要另行收取的交通费用。</br>5）如旅游者系港澳台人士，或持外籍护照，请在报名之前联系客服并告知是否自备目的国签证及再次进入中国的有效证件。</br>6）本团相关信息和紧急联系方式，将在出团通知中载明。</br>7）景点游览顺序根据最终航班时间及目的地天气、道路、节庆等情况适当调整，但不减少景点。以出团通知单为最终确认。</br>8）团队按不产生单男单女的原则分房，在不影响团队分房原则的前提下安排夫妻一间房，散拼团队因单男单女问题可能产生夫妻、亲属、朋友等不同房，请予以谅解和配合。</br>9）如报名人数出现单数，请与客服确认是否可以拼房，如供应商实在无法安排，则游客要自理单间差。</br>10）强烈建议所有游客购买旅游意外伤害保险；旅行社代为办理的保险，保险公司行业规定：3岁以下及70岁以上客人不在旅游意外保险投保范围内，请游客自行选择其他险种；</br>11）对于年满70周岁以上的参团游客，必须提供二级甲等或以上医院开具的相关健康证明并提供子女同意书原件；对于75周岁以上的老人，原则上我社不建议客人出行。未成年儿童出行必须有法定监护人陪伴。</br>12）此行程为参考行程，供应商可以根据人数、航班、签证及目的国之变化，保留调整之权利。</br>13）若客人取消行程，需支付行程内包含的机票、
                旅游者参加高原地区旅游或风险旅游项目（包括但不限于：游泳、浮潜、冲浪、漂流等水上活动以及骑马、攀岩、登山等高风险的活动）或患有不宜出行旅游的 病情（包括但不限于：恶性肿瘤、心血管病、高血压、呼吸系统疾病、癫痫、怀孕、精神疾病、身体残疾、糖尿病、传染性疾病、慢性疾病健康受损），建议在报名
                前自行前往医疗机构体检或自行咨询医院专业医生意见，以确保自身身体条件能够完成本次旅游活动。
                </br>2） 如自身身体条件不适宜出游而参加旅游活动的，在行程中因自身身体条件引发的疾病或70损害由旅游者本人承担相关责任；旅游者如系70上（含70岁）人员出游的，本人需充分考虑自身健康状况能够完成本次旅游活动，谨慎出游，建议要有亲友陪同出游，如因旅游者自身身体原因引发疾病或其他损害由旅游者
                本人承担相关责任。
                </br>3）上述内容作为真旅给予旅游者的重要出游安全提示，如旅游者仍坚持参加旅游活动，由此造成任何人身意外及不良后果将由旅游者本人承担全部责任。为了获得更为全面的保障，真旅强烈建议旅游者出游时根据个人意愿和需要自行投保人身意外伤害保险等个人险种。</br>4）不可抗力是指不能预见、不能避免并不能克服的客观情况。不可抗力、意外事件等不可归责于旅行社的客观原因包括但不限于，恶劣天气、自然灾害、战争、罢
                工、骚乱、飞机故障、航班保护、恐怖事件、政府行为、公共卫生事件等客观原因，造成旅游行程安排的交通服务延误、景区临时关闭、宾馆饭店临时被征用、出境 管制、边境关闭、目的地入境政策临时变更、我国政府机构发布橙色及以上旅游预警信息等，均会导致旅游目的无法实现，旅行社不承担违约责任。</br>5）在自行安排活动期间，旅游者应在自己能够控制风险的范围内活动，旅游者应选择自己能够控制风险的活动项目，并对自己的安全负责。</br>6）
                旅游期间或自行安排活动期间请注意人身和财产安全。旅游者因违约、自身过错、自行安排活动期间内的行为或自身疾病引起的人身、财产损失由其自行承担； 由此给旅行社或其他服务提供方造成损失的，旅游者应当承担赔偿责任。为了获得更为全面的保障，乙方强烈建议旅游者出游时根据个人意愿和需要自行投保人身意
                外伤害保险等个人险种。
            </p>
        </div>
    </div>

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/handlebars-v4.0.5.js"></script>
    <script src="js/mui.min.js"></script>
    <script src="js/swiper-3.4.2.jquery.min.js"></script>
    <script src="js/jq-plugins.js"></script>
    <script src="projectJs/jQuery.md5.js"></script>
    <script src="projectJs/normal.js"></script>
    <script id="travelOrderDetail-template" type="text/x-handlebars-template">
        <div class="orderStatus">
            <div class="statusHint">
                <span class="successIcon"></span>
                <span class="greenFonts">{{GetOrderDetailResponse.orderDetail.logs.[0].log}}</span>
            </div>
            <div class="orderNumber">订单号：{{GetOrderDetailResponse.orderDetail.logs.[0].extraId}}</div>
            <div class="hintTime">{{GetOrderDetailResponse.orderDetail.logs.[0].updateDate}} {{GetOrderDetailResponse.orderDetail.logs.[0].operatorName}}</div>
        </div>
        <div class="commonStyle orderDetailModel">
            <div class="orderTitle">
                <span class="orderTitleIcon"></span>
                <span class="orderTitleFonts"> {{GetOrderDetailResponse.orderDetail.orderGroup.tourRouteName}} </span>
                <a href="" class="rightIconArea"  onclick="productAction()">
                    <span class="rightIcon"></span>
                </a>
            </div>
            <div class="orderInfo">
                <span class="leftInfo">线路编号：{{GetOrderDetailResponse.orderDetail.orderGroup.tourRouteId}}</span>
                <span class="rightInfo">出发地：{{GetOrderDetailResponse.orderDetail.orderGroup.sourcePlace}}</span>
            </div>
            <div class="orderInfo">
                <span class="leftInfo">出发日期：{{GetOrderDetailResponse.orderDetail.orderGroup.departureDate}}</span>
                <span class="rightInfo">天数：{{GetOrderDetailResponse.orderDetail.orderGroup.numberOfJourneyDays}}</span>
            </div>
        </div>
        <div class="commonStyle travelerInfo">
            <div class="contactsModel">
                <h3 class="commonTitle">
                    <span class="contactsIcon"></span>
                    <span>联系人</span>
                </h3>
                <ul class="travelerDetails">
                    <li>
                        <div class="detailsInfo">
                            <span class="leftInfo">{{GetOrderDetailResponse.orderDetail.orderGroup.contactName}}</span>
                            <span class="rightInfo">手机号 &nbsp; {{GetOrderDetailResponse.orderDetail.orderGroup.contactTel}}</span>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="travelerInfoModel">
                <h3 class="commonTitle">
                    <span class="travelerInfoIcon"></span>
                    <span>旅客信息</span>
                </h3>
                <ul class="travelerDetails">
                    {{#each GetOrderDetailResponse.orderDetail.visitors}}
                    <li>
                        <div class="detailsInfo">
                            <span {{#if cnName}} class="leftInfo">{{cnName}} &nbsp;
                            {{else if pyName}}
                             class="leftInfo">{{pyName}} &nbsp;
                            {{else}}
                             class="leftInfo">旅客 &nbsp;
                            {{/if}}

                            {{#travelOrderAduStatus isAdult}}
                            <em class="commonFontsStyle blueBg">成人</em>
                            {{else}}
                            <em class="commonFontsStyle blueBg">儿童</em>
                            {{/travelOrderAduStatus}}
                            {{#travelOrderHousePrice isBalance}}
                            <em class="commonFontsStyle blueBg">单房差</em>
                            {{else}}
                            {{/travelOrderHousePrice}}

                            </span>
                            <span class="rightInfo">{{cardType idType}} &nbsp; {{idNumber}}</span>
                        </div>
                        <div class="detailsInfo">
                            <span class="leftInfo">状态 &nbsp;
                                <em class="blueFonts">{{viewState}}</em>
                            </span>
                            <span class="rightInfo">手机号 &nbsp; {{mobelPhone}}</span>
                        </div>

                        {{#stateEqual state}}
                        <div class="detailsInfo">
                            <span class="leftInfo">调价 &nbsp;
                                <em class="redFonts">{{opAuditAdjustFee}}元</em>
                            </span>
                            <span class="rightInfo">调价原因 &nbsp; {{ajustReason}}</span>
                        </div>
                        {{/stateEqual}}
                    </li>
                    {{/each}}
                </ul>
            </div>

        </div>
        <div class="costTotal">
            <div class="agreement">已同意 <a id="orderRules">预订协议</a></div>
            <ul class="totalModule">
                <li>应收合计：
                    <span class="redFonts">
                        ￥<span class="totalPrice">{{GetOrderDetailResponse.orderDetail.order.totalOrderFee}}</span>
                    </span>
                </li>
                {{#if GetOrderDetailResponse.orderDetail.order.countOfAdult}}
                <li>成人费用：{{GetOrderDetailResponse.orderDetail.orderGroup.adultSalePrice}}x{{GetOrderDetailResponse.orderDetail.order.countOfAdult}}</li>
                {{/if}} {{#if GetOrderDetailResponse.orderDetail.order.countOfChild}}
                <li>儿童费用：{{GetOrderDetailResponse.orderDetail.orderGroup.childSalePrice}}x{{GetOrderDetailResponse.orderDetail.order.countOfChild}}</li>
                {{/if}} {{#if GetOrderDetailResponse.orderDetail.order.countOfBalance}}
                <li>单房差：{{GetOrderDetailResponse.orderDetail.orderGroup.balancePrice}}x{{GetOrderDetailResponse.orderDetail.order.countOfBalance}}</li>
                {{/if}} {{#if GetOrderDetailResponse.orderDetail.order.abortFee}}
                <li>退团费：{{GetOrderDetailResponse.orderDetail.order.abortFee}}</li>
                {{/if}} {{#if GetOrderDetailResponse.orderDetail.order.adjustFee}}
                <li>调价：{{GetOrderDetailResponse.orderDetail.order.adjustFee}}</li>
                {{/if}}
            </ul>
        </div>
        <div class="bottomBtn">
            <a href="javascript:void(0);" onclick="firstAction()" class="clBlue" id="firstTravelDetailBtn">取消</a><a href="javascript:void(0);"
                onclick="secondAction()" class="clBlue" id="secondTravelDetailBtn">支付</a><a href="javascript:void(0);" class="clBlue"
                id="thirdTravelDetailBtn" onclick="thirdAction()">确认</a>
        </div>
    </script>

    <script>
        $(document).on('tap','.rightIconArea',function(){
            window.location.href = $(this).attr('href')
        })
        $('#backLast').on('click', function () {
            $('#orderRulesContent').removeClass('moveShow')
        })
        mui(document).on('tap','#orderRules', function () {
            $('#orderRulesContent').addClass('moveShow');
        })
        window.localStorage.travelProductStatus = 2;

        //按钮操作识别  0取消  1支付  2发起退团  3取消询位  4取消退团 5确认调价  -1没有任何操作
        var operator;
        //每个按钮对应的操作
        var firstOp = -1;
        var secondOp = -1;
        var thirdOp = -1;

        //返回
        function mineInfoBack() {
            window.location.href = "travel-order.html";
        };

        //产品详情
        function productAction() {
            window.localStorage.removeItem("adultAdvicePrice");
            window.localStorage.removeItem("adultDefaultPrice");
            window.location.href = "product-detail.html?routeId=" + window.localStorage.proID;
        }

        $(function () {

            //获取旅游订单详情
            travelOrderDetail();

        });

        function firstAction() {
            orderStatusOperator(firstOp);
        }

        function secondAction() {
            orderStatusOperator(secondOp);
        }

        function thirdAction() {
            orderStatusOperator(thirdOp);
        }

        function orderStatusOperator(status) {
            if (status == 0) {
                window.location.href = "league-apply.html";
            } else if (status == 1) {
                window.localStorage.removeItem("payStyle");
                window.location.href = "order-pay.html";
            } else if (status == 2) {
                window.location.href = "league-apply.html";
            } else if (status == 3) {
                cancelInquirySeat();
            } else if (status == 4) {
                window.location.href = "cancal-league.html";
            } else if (status == 5) {
                window.location.href = "sure-league.html";
            } else {
                alert("无任何操作");
            }
        }

        //取消询位
        function cancelInquirySeat() {
            var routeDetail = {};
            routeDetail.orderId = window.localStorage.travelorderID;
            routeDetail.curCustomerKey = defaultLoginrespon().apiUserName;

            var dataRequest = {};
            dataRequest.requestMetaInfo = requestData();
            dataRequest.InquireSeatCancelRequest = routeDetail;

            var url = travelLink();
            $.ajax({
                url: url,
                dataType: 'json',
                data: JSON.stringify(dataRequest),
                type: 'post',
                contentType: "application/json;utf-8",
                success: function (data) {
                    if (data.responseMetaInfo.resultCode == 0) {
                        if (data.InquireSeatCancelResponse.status == "SUCCESS") {
                            window.location.reload();
                        } else {
                            alert(data.InquireSeatCancelResponse.message)
                        }
                    } else {
                        alert(data.responseMetaInfo.reason);
                    }
                },
                error: function (data) {

                }
            });
        }


        function travelOrderDetail() {

            var localStorage = window.localStorage;
            var routeDetail = {};
            routeDetail.customerkey = defaultLoginrespon().userKey;
            routeDetail.orderId = localStorage.travelorderID;

            var dataRequest = {};
            dataRequest.requestMetaInfo = requestData();
            dataRequest.GetOrderDetailRequest = routeDetail;

            var url = travelLink();
            $.ajax({
                url: url,
                dataType: 'json',
                data: JSON.stringify(dataRequest),
                type: 'post',
                contentType: "application/json;utf-8",
                success: function (data) {
                    if (data.responseMetaInfo.resultCode == 0) {
                        var myTemplate = Handlebars.compile($("#travelOrderDetail-template").html());
                        $('.contentWrapper').html(myTemplate(data));

                        localStorage.proID = data.GetOrderDetailResponse.orderDetail.orderGroup.tourRouteId;
                        localStorage.travelorderPrice = data.GetOrderDetailResponse.orderDetail.order.remainFee;

                        var payPrice = parseFloat(data.GetOrderDetailResponse.orderDetail.order.remainFee).toFixed(2);

                        //订单可执行操作判断
                        if (data.GetOrderDetailResponse.orderDetail.order.state == "cancel" || data.GetOrderDetailResponse
                            .orderDetail.order.state == "complete") {
                            $("#firstTravelDetailBtn").hide();
                            $("#secondTravelDetailBtn").hide();
                            $("#thirdTravelDetailBtn").hide();
                        } else if (data.GetOrderDetailResponse.orderDetail.order.state == "canPay") {
                            $("#thirdTravelDetailBtn").hide();
                            $("#firstTravelDetailBtn").text("取消");
                            $("#firstTravelDetailBtn").width(1.5 * $("#firstTravelDetailBtn").width());
                            $("#secondTravelDetailBtn").width(1.5 * $("#secondTravelDetailBtn").width());
                            $("#secondTravelDetailBtn").text("支付(￥" +  payPrice + ")");
                            $("#secondTravelDetailBtn").css("background-color", "#ff6565");


                            if (data.GetOrderDetailResponse.orderDetail.canSignBackVisitors.length > 0) {
                                if (data.GetOrderDetailResponse.orderDetail.paidFee > 0) {
                                    $("#firstTravelDetailBtn").text("发起退团");
                                    firstOp = 4;
                                } else {
                                    $("#firstTravelDetailBtn").text("取消");

                                    firstOp = 0;
                                }

                                secondOp = 1;

                                //发起退团常旅客保存
                                window.localStorage.canSignBackVisitors = JSON.stringify(data.GetOrderDetailResponse
                                    .orderDetail.canSignBackVisitors)
                            } else {
                                firstOp = 1;
                                $("#secondTravelDetailBtn").hide();
                                $("#firstTravelDetailBtn").text("支付(￥" +  payPrice + ")");
                                $("#firstTravelDetailBtn").width(3 * $("#thirdTravelDetailBtn").width());
                                $("#firstTravelDetailBtn").css("background-color", "#ff6565");
                            }
                        } else if (data.GetOrderDetailResponse.orderDetail.order.state ==
                            "inquirySeatPro_processing") {
                            $("#secondTravelDetailBtn").hide();
                            $("#thirdTravelDetailBtn").hide();

                            $("#firstTravelDetailBtn").width(3 * $("#firstTravelDetailBtn").width());
                            $("#firstTravelDetailBtn").text("取消询位");
                            firstOp = 3;
                        } else if (data.GetOrderDetailResponse.orderDetail.order.state == "changing") {
                            $("#firstTravelDetailBtn").hide();
                            $("#secondTravelDetailBtn").hide();
                            $("#thirdTravelDetailBtn").hide();


                            var flagPro = false;
                            if (data.GetOrderDetailResponse.orderDetail.canSignBackVisitors.length > 0) {
                                $("#firstTravelDetailBtn").show();
                                $("#firstTravelDetailBtn").text("发起退团");
                                flagPro = true;

                                firstOp = 2;

                                //发起退团常旅客保存
                                window.localStorage.canSignBackVisitors = JSON.stringify(data.GetOrderDetailResponse
                                    .orderDetail.canSignBackVisitors)
                            }

                            //已经发起退团  然后判断可以取消退团
                            var visitorSignBacks = new Array();
                            var flagQuit = false;
                            var hasSignVisitor = data.GetOrderDetailResponse.orderDetail.visitorSignBacks;
                            for (var i = 0; i < hasSignVisitor.length; i++) {
                                var visitor = hasSignVisitor[i];
                                if (visitor.state == "pchSignBackOp_complete" || visitor.state ==
                                    "pchSignBackOp_reject" || visitor.state == "pchSignBackOp_processing" ||
                                    visitor.state == "pchSignBackPro_processing" || visitor.state ==
                                    "pchSignBackPur_reject") {
                                    flagQuit = true;
                                    visitorSignBacks.push(visitor);
                                }
                            }

                            window.localStorage.removeItem("visitorSignBacks");
                            if (flagQuit) //显示  取消退团按钮
                            {
                                //取消退团常旅客保存
                                window.localStorage.visitorSignBacks = JSON.stringify(visitorSignBacks)

                                secondOp = 4;

                                $("#secondTravelDetailBtn").show();
                                $("#secondTravelDetailBtn").text("取消退团");
                                
                            }

                            //确认调价
                            var flagSure = false;
                            var visitorNormals = new Array();
                            var sureSignVisitor = data.GetOrderDetailResponse.orderDetail.visitorNormals;
                            for (var i = 0; i < sureSignVisitor.length; i++) {
                                var visitor = sureSignVisitor[i];
                                if (visitor.state == "adjustPriceOp_complete") {
                                    flagSure = true;
                                    visitorNormals.push(visitor);
                                }
                            }

                            window.localStorage.removeItem("visitorNormals");
                            //确认调价
                            if (flagSure) {
                                thirdOp = 5;
                                $("#thirdTravelDetailBtn").show();
                                $("#thirdTravelDetailBtn").text("确认调价");



                                //取消退团常旅客保存
                                window.localStorage.visitorNormals = JSON.stringify(visitorNormals)
                            }

                            if (flagPro) {
                                if (flagQuit) {
                                    if (flagSure) //3个操作按钮都存在不用改变大小
                                    {

                                    } else {
                                        $("#firstTravelDetailBtn").width(1.5 * $("#thirdTravelDetailBtn").width());
                                        $("#secondTravelDetailBtn").width(1.5 * $("#thirdTravelDetailBtn").width());
                                    }
                                } else {
                                    if (flagSure) {
                                        $("#firstTravelDetailBtn").width(1.5 * $("#secondTravelDetailBtn").width());
                                        $("#thirdTravelDetailBtn").width(1.5 * $("#secondTravelDetailBtn").width());
                                    } else {
                                        $("#firstTravelDetailBtn").width(3 * $("#thirdTravelDetailBtn").width());
                                    }
                                }
                            } else {
                                if (flagQuit) {
                                    if (flagSure) {

                                        $("#secondTravelDetailBtn").width(1.5 * $("#firstTravelDetailBtn").width());
                                        $("#thirdTravelDetailBtn").width(1.5 * $("#firstTravelDetailBtn").width());
                                    } else {
                                        $("#secondTravelDetailBtn").width(3 * $("#firstTravelDetailBtn").width());
                                    }
                                } else {
                                    if (flagSure) {
                                        $("#thirdTravelDetailBtn").width(3 * $("#firstTravelDetailBtn").width());
                                    } else {
                                        //没有任何操作按钮
                                    }
                                }
                            }

                        } else if (data.GetOrderDetailResponse.orderDetail.order.state == "confirm") {
                            firstOp = 2;

                            $("#firstTravelDetailBtn").text("发起退团");
                            $("#secondTravelDetailBtn").hide();
                            $("#thirdTravelDetailBtn").hide();
                            $("#firstTravelDetailBtn").width(3 * $("#firstTravelDetailBtn").width());

                            window.localStorage.canSignBackVisitors = JSON.stringify(data.GetOrderDetailResponse
                                .orderDetail.canSignBackVisitors)
                        } else {
                            $("#firstTravelDetailBtn").hide();
                            $("#secondTravelDetailBtn").hide();
                            $("#thirdTravelDetailBtn").hide();
                        }
                    } else {
                        alert("网络异常");
                    };
                     $("#firstTravelDetailBtn").css('border-right','1px solid #fff');
                     $("#secondTravelDetailBtn").css('border-right','1px solid #fff');
                },
                error: function (data) {

                }
            });
        }

        Handlebars.registerHelper("passerentType", function (str) {

        });

        Handlebars.registerHelper("cardType", function (str) {
            if (str == "IDENTITY_CARD") {
                return "身份证";
            } else if (str == "PASSPORT") {
                return "护照";
            } else if (str == "OTHER") {
                return "其他";
            } else if (str == "LATER") {
                return "稍后提供";
            } else {
                return "稍后提供";
            }
        });
    </script>

</body>

</html>