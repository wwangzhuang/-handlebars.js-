<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>活动专区列表</title>
        <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <meta http-equiv="pragma" content="no-cache">
        <meta http-equiv="cache-control" content="no-cache">
        <meta http-equiv="expires" content="0">
        <script>
            document.documentElement.style.fontSize = window.innerWidth / 7.5 + 'px';
        </script>
        <link rel="stylesheet" href="css/mui.min.css">
        <link rel="stylesheet" href="css/swiper-3.4.2.min.css">
        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/details.css">
        <link rel="stylesheet" href="css/pullToRefresh.css" />
        <style>
            .searchList-nav {
                display: table;
                width: 100%;
                border-bottom: 1px solid #f2f2f2;
            }
            .searchList-nav span {
                display: table-cell;
                height: .8rem;
                line-height: .8rem;
                text-align: center;
                color: #999;
                font-size: .3rem;
            }
            .searchList-nav span.active {
                color: #fe6664;
                border-bottom: 2px solid #fe6664;
            }
            .searchList-main {
                position: absolute;
                top: 1.64rem;
                left: 0;
                right: 0;
                bottom: 1.08rem;
            }
            .searchList-main .product-box {
                margin: .2rem;
            }
        </style>
    </head>

    <body>
        <div class="common-header">
            <div class="icon-back">
                <a href="#"></a>
            </div>
            <div class="common-title">活动专区</div>
        </div>
        <div>
            <div id="div-activityList"></div>
        </div>
        <!--<div class="searchList-nav" id="temp-searchNav">
            <span class="nav-item active">
                <i class="commonListIcon grayTravelIcon activeIcon"></i>
                <em>旅游</em>
            </span>
            <span class="nav-item">
                <i class="commonListIcon grayShipIcon"></i>
                <em>邮轮</em>
            </span>
            <span class="nav-item">
                <i class="commonListIcon grayVisaIcon"></i>
                <em>签证</em>
            </span>
            <span class="nav-item">
                <i class="commonListIcon grayHotelIcon"></i>
                <em>酒店</em>
            </span>
        </div>-->
        <script id="template-activityList" type="text/x-handlebars-template">
            <div class="margin20">
                <ul id="temp-searchList">
                    {{#each SearchProductByKeyResponse.products.[0].activitys}}
                    <li class="product-box">
                        <a href="#" class="proList-link">
                            <div class="pic-box">
                                <img src="{{url}}" alt="">
                                <div class="tagType tagType01">
                                    <span class="imgFonts">{{label1}}{{label2}}</span>
                                </div>
                                <div class="list-timeout"><span class="timeSpan"></span>{{activityText status}}</div>
                                <div class="sellOut displayNone">
                                    <span class="sellOutImg"></span>
                                </div>
                            </div>
                            <div class="product-details">
                                <p class="titleFonts"><i class="commonClassifyIcon xianIcon"><img src="images/hdz.png" alt=""></i>{{productName}}</p>
                                <div class="clearfix">
                                    <div class="priceLeft">
                                        <span class="redFonts">￥<span class="number">{{promotionPrice}}</span></span>
                                    </div>
                                    <div class="residueRight color666">
                                        <span>
                                            <em class="blueFonts">剩余</em>
                                            <em class="redFonts">{{numberOfRemain}}</em>
                                            <span>件</span>
                                        </span>
                                        <span class="redBorder">
                                            <i class="speedRobIcon"></i>
                                            <em class="redFonts">速抢</em>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </li>
                    {{/each}}
                </ul>
            </div>
        </script>
        
        <script src="js/jquery-3.1.1.min.js"></script>
        <script src="js/handlebars-v4.0.5.js"></script>
        <script src="js/mui.min.js"></script>
        <script src="js/swiper-3.4.2.jquery.min.js"></script>
        <script src="js/jq-plugins.js"></script>
        <script src="projectJs/jQuery.md5.js"></script>
        <script src="projectJs/normal.js"></script>
        <script src="js/iscroll.js"></script>
        <script src="js/pullToRefresh.js"></script>
    
        <script>
            var activityDate = {};




                function travellerProductCategoryRequest(){
                var routeDetail = {};
                routeDetail.searchWord = "59f84a3f60b17b404978a52b";
                var dataRequest = {};
                dataRequest.requestMetaInfo = requestData();
                dataRequest.SearchProductByKeyRequest = routeDetail;
                var url = activityLink();
                $.ajax({
                    url: url,
                    dataType: 'json',
                    data: JSON.stringify(dataRequest),
                    type: 'post',
                    contentType: "application/json;utf-8",
                    success: function (data) {



                        if(data.responseMetaInfo.resultCode == 0)
                        {
                            activityDate = data;

                            var myTemplate = Handlebars.compile($("#template-activityList").html());
                            $('#div-activityList').html(myTemplate(data));

                            timerAction();
                        }
                    },
                    error: function () {

                    }
                });
            }

            function timerAction() {

                <!--倒计时-->
                for(var i=0; i<activityDate.SearchProductByKeyResponse.products[0].activitys.length; i++)
                {

                    var firstTime = activityDate.SearchProductByKeyResponse.products[0].activitys[i].beginDate;
                    var endTime = activityDate.SearchProductByKeyResponse.products[0].activitys[i].endDate;
                    var serverTime = activityDate.SearchProductByKeyResponse.openApiServerDate;

                    var activityStartTime = parseInt(firstTime);
                    var activityEndTime = parseInt(endTime);
                    var currServerTime = parseInt(serverTime);

                    var time ;//= starttime - nowtime;

                    var iCountParam = setInterval(function () {

                        var day = parseInt(time / 1000 / 60 / 60 / 24);
                        var hour = parseInt(time / 1000 / 60 / 60 % 24);
                        var minute = parseInt(time / 1000 / 60 % 60);
                        var seconds = parseInt(time / 1000 % 60);
                        if (day <= 9) day = '0' + day;
                        if (hour <= 9) hour = '0' + hour;
                        if (minute <= 9) minute = '0' + minute;
                        if (seconds <= 9) seconds = '0' + seconds;
                        //倒计时-1s
                        time = time-1000/activityDate.SearchProductByKeyResponse.products[0].activitys.length;
                        //当前时间+1s
                        currServerTime = currServerTime + 1000;

                        console.log(time);
                        if(day == '00' && hour == '00' && minute == '00' && seconds == '00')
                        {
                            if(activityStartTime > currServerTime)    //等待开始
                            {
                                time = currServerTime - activityStartTime;
                            }
                            else
                            {
                                if(activityEndTime > currServerTime)   //活动中
                                {
                                    time = activityEndTime - currServerTime;
                                    activityData.SearchProductByKeyResponse.products[0].activitys[i].status = 'runing'
                                    var myTemplate = Handlebars.compile($("#template-activityList").html());
                                    $('#div-activityList').html(myTemplate(data));
                                }
                                else//结束
                                {

                                    activityData.SearchProductByKeyResponse.products[0].activitys[i].status = 'end'
                                    var myTemplate = Handlebars.compile($("#template-activityList").html());
                                    $('#div-activityList').html(myTemplate(data));
                                    clearInterval(iCountParam);
                                }
                            }
                        }

                        if(day == '00')
                        {
                            $('.timeSpan').html("<span>" + hour + "</span>" + ":" + "<span>" + minute + "</span>" + ":" + "<span>" + seconds + "</span>");
                        }
                        else {
                            $('.timeSpan').html("<i>" + parseInt(day) + "</i>" + "天" + "<span>" + hour + "</span>" + ":" + "<span>" + minute + "</span>" + ":" + "<span>" + seconds + "</span>");
                        }
                    }, 1000);


                    if(activityStartTime > currServerTime)    //等待开始
                    {
                        time = activityStartTime - currServerTime;
                    }
                    else
                    {
                        if(activityEndTime > currServerTime)   //活动中
                        {
                            time = activityEndTime - currServerTime;
                        }
                        else//结束
                        {
                            $('.timeSpan').html("<span>" + '00' + "</span>" + ":" + "<span>" + '00' + "</span>" + ":" + "<span>" + '00' + "</span>");
                            clearInterval(iCountParam);
                        }
                    }
                }
            }
            $(function () {
                //
                var EventUtil = {
                    addHandler: function (element, type, handler) {
                        if (element.addEventListener) {
                            element.addEventListener(type, handler, false);
                        } else if (element.attachEvent) {
                            element.attachEvent("on" + type, handler);
                        } else {
                            element["on" + type] = handler;
                        }
                    }
                };
                (function () {
                    var showCount = 0;
                    EventUtil.addHandler(window, "load", function () {
                        alert("Load fired");
                    });
                    EventUtil.addHandler(window, "pageshow", function (event) {
                        showCount++;
                        alert("Show has been fired " + showCount + " times.");
                    });
                })();
                travellerProductCategoryRequest();

                // 顶部导航点击事件
                mui(document).on('tap', '.nav-item', function () {
                    $(this).addClass('active');
                    $('.nav-item').not(this).removeClass('active');
                    $(this).find("i").addClass('activeIcon');
                    $(this).siblings("span").find("i").removeClass('activeIcon');
                    $('.tabs-container').tabs();
                });


            })

//            function getHiddenProp(){
//                var prefixes = ['webkit','moz','ms','o'];
//
//                // if 'hidden' is natively supported just return it
//                if ('hidden' in document) return 'hidden';
//
//                // otherwise loop over all the known prefixes until we find one
//                for (var i = 0; i < prefixes.length; i++){
//                    if ((prefixes[i] + 'Hidden') in document)
//                        return prefixes[i] + 'Hidden';
//                }
//
//                // otherwise it's not supported
//                return null;
//            }
//
//            function getVisibilityState() {
//                var prefixes = ['webkit', 'moz', 'ms', 'o'];
//                if ('visibilityState' in document) return 'visibilityState';
//                for (var i = 0; i < prefixes.length; i++) {
//                    if ((prefixes[i] + 'VisibilityState') in document)
//                        return prefixes[i] + 'VisibilityState';
//                }
//                // otherwise it's not supported
//                return null;
//            }
//
//            function isHidden() {
//                var prop = getHiddenProp();
//                if (!prop) return false;
//
//                return document[prop];
//            }
//
//            var visProp = getHiddenProp();
//            if (visProp) {
//                var evtname = visProp.replace(/[H|h]idden/, '') + 'visibilitychange';
//                document.addEventListener("webkitvisibilitychange", function () {
//                    if (document.webkitVisibilityState == 'visible') {
//                        window.location.href=window.location.href+"?id="+10000*Math.random();
//                        alert(123);
//                        travellerProductCategoryRequest();
//                    }
//                },false);
//            }
//            function isWeiXin(){
//                var ua = window.navigator.userAgent.toLowerCase();
//                if(ua.match(/MicroMessenger/i) == 'micromessenger'){
//                    return true;
//                }else{
//                    return false;
//                }
//            }

//            document.addEventListener("WeixinJSBridgeReady",function(){
//                WeixinJSBridge.call("showToolbar");
//                alert(123);
//                if (document.webkitVisibilityState == 'visible') {
//                    window.location.href=window.location.href+"?id="+10000*Math.random();
//                    alert(1);
//
//                }
//            });
//            document.addEventListener('webkitvisibilitychange',function() {
//
//                if (document.webkitVisibilityState == 'hidden') {
//
//                }else{
//                    window.location.href=window.location.href+"?id="+10000*Math.random();
//                    alert(1);
//                }
//            })
//
//            document.addEventListener('msvisibilitychange',function() {
//
//                if (document.webkitVisibilityState == 'visible') {
//                    window.location.href=window.location.href+"?id="+10000*Math.random();
//                    alert(2);
//
//                }
//            })
//
//            document.addEventListener('mozvisibilitychange',function() {
//
//                if (document.webkitVisibilityState == 'visible') {
//                    window.location.href=window.location.href+"?id="+10000*Math.random();
//                    alert(3);
//
//                }
//            })
//
//            document.addEventListener('visibilitychange',function() {
//
//                if (document.webkitVisibilityState == 'visible') {
//                    window.location.href=window.location.href+"?id="+10000*Math.random();
//                    alert(4);
//
//                }
//            })

            // 各种浏览器兼容
            var hidden, state, visibilityChange;
            if (typeof document.hidden !== "undefined") {
                hidden = "hidden";
                visibilityChange = "visibilitychange";
                state = "visibilityState";
            } else if (typeof document.mozHidden !== "undefined") {
                hidden = "mozHidden";
                visibilityChange = "mozvisibilitychange";
                state = "mozVisibilityState";
            } else if (typeof document.msHidden !== "undefined") {
                hidden = "msHidden";
                visibilityChange = "msvisibilitychange";
                state = "msVisibilityState";
            } else if (typeof document.webkitHidden !== "undefined") {
                hidden = "webkitHidden";
                visibilityChange = "webkitvisibilitychange";
                state = "webkitVisibilityState";
            }

            // 添加监听器，在title里显示状态变化
            document.addEventListener(visibilityChange, function() {
                window.location.href=window.location.href+"?id="+10000*Math.random();
                alert(1);
                return false;
            }, false);

            // 初始化
//            document.title = document[state];
        </script>
    </body>

</html>