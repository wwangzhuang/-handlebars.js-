<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <script>
        document.documentElement.style.fontSize = window.innerWidth / 7.5 + 'px';
    </script>
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" href="css/swiper-3.4.2.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/details.css">

    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function(){
            _vds.push(['setAccountId', 'aeea6ff5baedd18e']);
            (function() {
                var vds = document.createElement('script');
                vds.type='text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
    <script type='text/javascript' src='https://assets.growingio.com/sdk/wx/vds-wx-plugin.js'></script>
</head>

<body>
    <div class="common-header">
        <div class="icon-back"  onclick="mineInfoBack()">
            <a href="#"></a>
        </div>
        <div class="common-title">
            注册
        </div>
    </div>
    <div class="registerModule">
        <div class="registerChange">
            <div class="area">
                <span class="leftArea">地区</span>
                <span class="rightArea">中国大陆 +86</span>
            </div>
            <ul class="writeInfo">
                <li>
                    <span class="commonIcon phoneIcon"></span>
                    <input type="text" placeholder="请输入手机号" value="" id="writePhone"/>
                </li>
                <li>
                    <span class="commonIcon codeIcon"></span>
                    <input type="text" placeholder="请输入右侧验证码" value="" id="register-verificationCode-text"/>
                    <img src="images/verificationCode.jpg" alt="" class="verificationCode" id="register-verificationCode-image"/>
                </li>
                <li>
                    <span class="commonIcon codeIcon"></span>
                    <input type="text" placeholder="请输入短信验证码" value="" id="register-input-code"/>
                    <a href="javascript:void(0);" class="gainPw" id="register-phone-code">获取验证码</a>
                </li>
                <li>
                    <span class="commonIcon psIcon"></span>
                    <input type="text" placeholder="6-18位数字和字母组合" value="" id="register-password-input"/>
                </li>
            </ul>
        </div>
        <div class="bigRegisterBtn">
            <a href="javascript:void(0);" class="bigRedBg" id="register-action">注 册</a>
        </div>
        <div class="registerAgreement">
            <span>注册即同意并阅读</span>
            <a onclick="agree()" class="redFonts">《真旅用户注册协议》</a>
        </div>
    </div>

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/handlebars-v4.0.5.js"></script>
    <script src="js/mui.min.js"></script>
    <script src="js/swiper-3.4.2.jquery.min.js"></script>
    <script src="js/jq-plugins.js"></script>
    <script src="projectJs/jQuery.md5.js"></script>
    <script src="projectJs/normal.js"></script>

    <script>
        function mineInfoBack(){
            window.location.href = "login.html";
        };

        function agree(){
            window.location.href="register-agreement.html?q=reg";
        }
        $(function(){
            //获取图形验证码
            codeEvent();

            $(".registerList li").each(function(index){
                $(this).click(function(){
                    $(".registerContent .registerChange").hide();
                    $(".registerContent .registerChange:eq(" + index + ")").show();
                    $(".registerList li").removeClass("current");
                    $(this).addClass("current");
                });
            });

            //刷新图形验证码
            $("#register-verificationCode-image").click(function () {
                codeEvent();
            });

            //获取短信验证码
            $("#register-phone-code").click(function () {
                if (!safevalid())
                {
                    return;
                }

                var strText = $("#register-phone-code").text();
                if (strText == "获取验证码")
                {
                    pPhoneNumberHasUse()
                }
            });

            //注册事件
            $("#register-action").click(function () {
                if (!safevalid())
                {
                    return;
                }

                registerAction();

            });
        });

        ///mobileLogin/checkMobileExist
        function pPhoneNumberHasUse() {

            var phoneNumber = $("#writePhone").val();
            if (!validatemobile(phoneNumber))
            {
                return false;
            }

            var url = "https://app.travelzen.com/tops-openapi-for-customers/mobileLogin/checkMobileExist?mobileNumber=";
            if (isOp3 == 1) {
                url = "http://192.168.161.137:8480//mobileLogin/checkMobileExist?mobileNumber=";
            }
            url = url + phoneNumber;
            $.ajax({
                url: url,
                dataType: 'json',
                type: 'post',
                contentType: "application/json;utf-8",
                success: function (data) {
                    if(data.result == "SUCCESS")
                    {
                        signCodeNumber();
                    }
                    else
                    {
                        alert(data.errInfo);
                    }
                },
                error: function (data) {
                    alert("网络异常");
                }
            });
        }
        
        //安全验证
        function safevalid() {

            var phoneNumber = $("#writePhone").val();
            if (!validatemobile(phoneNumber))
            {
                return false;
            }

            //判断图形验证码正确
            var strCode = $("#register-verificationCode-text").val();
            if(strCode.length <= 0)
            {
                alert("请输入验证码");
                return false;
            }
            var registerCode = $("#register-verificationCode-image").data("valueImg");
            if(strCode.toLocaleLowerCase() != registerCode.toLocaleLowerCase())
            {
                alert("请输入正确的验证码");
                return false;
            }
            return true;
        }

        //获取图片验证
        function codeEvent() {
            var timelong = Date.parse(new Date());

            //保存当前时间戳 用于获取验证码数据
            $("#register-verificationCode-image").data("valueDeviceId", timelong);

            var url = "https://app.travelzen.com/tops-openapi-for-customers/mobileLogin/identifyingCode?key=";
            if (isOp3 == 1) {
                url = "http://192.168.161.137:8480//mobileLogin/identifyingCode?key=";
            }
            url = url + timelong;
            $.ajax({
                url: url,
                dataType: 'json',
                type: 'post',
                contentType: "application/json;utf-8",
                success: function (data) {
                    if (data.hasOwnProperty("imageStr")) {
                        var imgData = "data:image/png;base64,";
                        imgData = imgData + data.imageStr;
                        $("#register-verificationCode-image").attr("src", imgData);
                        $("#register-verificationCode-image").data("valueImg", data.value)
                    }
                },
                error: function (data) {
                    alert("网络异常");
                }
            });
        }

            //获取短信验证码
            function signCodeNumber() {
                var strCodeValue = $("#register-verificationCode-image").data("valueImg");
                var strUrl = "type=0&mobileNumber=" + $("#writePhone").val() + "&identifyingCode=" + strCodeValue + "&deviceId=" + $("#register-verificationCode-image").data("valueDeviceId");
                var url = "https://app.travelzen.com/tops-openapi-for-customers/mobileLogin/verificationCode?";
                if (isOp3 == 1)
                {
                    url = "http://192.168.161.137:8480/mobileLogin/verificationCode?";
                }
                url = url + strUrl;
                $.ajax({
                    url: url,
                    dataType: 'json',
                    type: 'post',
                    contentType: "application/json;utf-8",
                    success: function (data) {
                        if(data.result == "FAIL")
                        {
                            alert(data.errInfo);
                        }
                        else
                        {
                            //判断当前是否是在倒计时
                            var countdown=60;
                            timerOut(countdown);
                        }
                    },
                    error: function (data) {
                        alert("网络异常");
                    }
                });
            }

            //注册接口
            function registerAction() {
                if (!safevalid()) {
                    return;
                }

                var phoneCode = $("#register-input-code").val();
                if (phoneCode.length <= 0) {
                    alert("请输入短信验证码");
                    return;
                }

                var registerPass = $("#register-password-input").val();
                if (registerPass.length <= 0) {
                    alert("请输入密码");
                    return;
                }

                //判断是否是字母和数字的组合
                if(!checkRate(registerPass))
                {
                    alert('请输入6~18位字母和数字的组合');
                    return;
                }

                if (registerPass.length < 6 || registerPass.length > 18) {
                    alert('请输入6~18位有效的密码');
                    return;
                }

                var routeDetail = {};
                routeDetail.deviceId = $("#register-verificationCode-image").data("valueDeviceId");
                routeDetail.identifyingCode = $("#register-verificationCode-text").val();
                routeDetail.mobileNumber = $("#writePhone").val();
                routeDetail.password = $("#register-password-input").val();
                routeDetail.verificationCode = $("#register-input-code").val();

                var dataRequest = {};
                dataRequest.requestMetaInfo = requestData();
                dataRequest.AppMobileRegisterRequest = routeDetail;


                var url = "https://app.travelzen.com/tops-openapi-for-customers/service/flight/register";
                if (isOp3 == 1)
                {
                    url = "http://192.168.161.137:8480/service/flight/register";
                }
                $.ajax({
                    url: url,
                    dataType: 'json',
                    data: JSON.stringify(dataRequest),
                    type: 'post',
                    contentType: "application/json;utf-8",
                    success: function (data) {
                        if(data.responseMetaInfo.resultCode == 0)
                        {
                            if(data.AppMobileRegisterResponse.result == "SUCCESS") {
                                logginRespon.userName = data.userName;
                                logginRespon.apiSignCode = data.apiSignCode;
                                logginRespon.apiUserName = data.apiUserName;
                                logginRespon.userKey = data.userKey;
                                logginRespon.contactMobile = data.contactMobile;
                                logginRespon.contactUserName = data.contactUserName;

                                window.location.href = "login.html";
                            }
                            else
                            {
                                alert(data.AppMobileRegisterResponse.errInfo);
                            }
                        }
                        else
                        {
                            alert(data.responseMetaInfo.reason);
                        }
                    },
                    error: function (data) {

                    }
                });
            }


        function timerOut(countdown)
        {
            if (countdown == 0) {
                $("#register-phone-code").text('获取验证码');
                countdown = 60;
            } else {
                $("#register-phone-code").text("重新发送(" + countdown + "s)");
                countdown--;
            }setTimeout(function() {
            if (countdown != 60) {
                timerOut(countdown)
            }
        },1000)
        }
    </script>
    

</body>

</html>