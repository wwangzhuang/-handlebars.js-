<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>找回密码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <script>
        document.documentElement.style.fontSize = window.innerWidth / 7.5 + 'px';
    </script>
    <link rel="stylesheet" href="css/mui.min.css">
    <link rel="stylesheet" href="css/swiper-3.4.2.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/details.css">

    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function(){
            _vds.push(['setAccountId', 'aeea6ff5baedd18e']);
            (function() {
                var vds = document.createElement('script');
                vds.type='text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
    <script type='text/javascript' src='https://assets.growingio.com/sdk/wx/vds-wx-plugin.js'></script>
</head>

<body>
<div class="common-header">
    <div class="icon-back" onclick="mineInfoBack()">
        <a href="#"></a>
    </div>
    <div class="common-title">
        找回密码
    </div>
</div>
<div class="registerModule">
    <div class="registerChange">
        <div class="area">
            <span class="leftArea">地区</span>
            <span class="rightArea">中国大陆 +86</span>
        </div>
        <ul class="writeInfo">
            <li>
                <span class="commonIcon phoneIcon"></span>
                <input type="text" placeholder="请输入手机号" value="" id="forgetpassword-writePhone"/>
            </li>
            <li>
                <span class="commonIcon codeIcon"></span>
                <input type="text" placeholder="请输入右侧验证码" value="" id="forgetpassword-verificationCode-text"/>
                <img src="images/verificationCode.jpg" alt="" class="verificationCode" id="forgetpassword-verificationCode-image"/>
            </li>
            <li>
                <span class="commonIcon codeIcon"></span>
                <input type="text" placeholder="请输入短信验证码" value="" id="forgetpassword-input-code"/>
                <a href="javascript:void(0);" class="gainPw" id="forgetpassword-phone-code">获取验证码</a>
            </li>
        </ul>
    </div>
    <div class="bigRegisterBtn">
        <a href="javascript:void(0);" class="bigRedBg" id="forgetpassword-action">重置密码</a>
    </div>
    <div class="registerAgreement">
        <span>提示:如果您手机号码已经无法进行相应的操作,请联系客服</span>
    </div>
</div>

<script src="js/jquery-3.1.1.min.js"></script>
<script src="js/handlebars-v4.0.5.js"></script>
<script src="js/mui.min.js"></script>
<script src="js/swiper-3.4.2.jquery.min.js"></script>
<script src="js/jq-plugins.js"></script>
<script src="projectJs/jQuery.md5.js"></script>
<script src="projectJs/normal.js"></script>

<script>
    
    function mineInfoBack(){
        window.location.href = "login.html";
    };

    $(function(){
        //获取图形验证码
        codeEvent();

        //刷新图形验证码
        $("#forgetpassword-verificationCode-image").click(function () {
            codeEvent();
        });

        //获取短信验证码
        $("#forgetpassword-phone-code").click(function () {
            if (!safevalid())
            {
                return;
            }

            var strText = $("#forgetpassword-phone-code").text();
            if (strText == "获取验证码")
            {
                signCodeNumber();
            }
        });

        //注册事件
        $("#forgetpassword-action").click(function () {
            if (!safevalid())
            {
                return;
            }

            registerAction();

        });


    });

    //安全验证
    function safevalid() {

        var phoneNumber = $("#forgetpassword-writePhone").val();
        if (!validatemobile(phoneNumber))
        {
            return false;
        }

        //判断图形验证码正确
        var strCode = $("#forgetpassword-verificationCode-text").val();
        if(strCode.length <= 0)
        {
            alert("请输入验证码");
            return false;
        }
        var registerCode = $("#forgetpassword-verificationCode-image").data("valueImg");
        if(strCode.toLocaleLowerCase() != registerCode.toLocaleLowerCase())
        {
            alert("请输入正确的验证码");
            return false;
        }
        return true;
    }

    //获取图片验证
    function codeEvent() {
        var timelong = Date.parse(new Date());

        //保存当前时间戳 用于获取验证码数据
        $("#forgetpassword-verificationCode-image").data("valueDeviceId", timelong);

        var url = "https://app.travelzen.com/tops-openapi-for-customers/mobileLogin/identifyingCode?key=";
        if (isOp3 == 1) {
            url = "http://192.168.161.137:8480//mobileLogin/identifyingCode?key=";
        }
        url = url + timelong;
        $.ajax({
            url: url,
            dataType: 'json',
            type: 'post',
            contentType: "application/json;utf-8",
            success: function (data) {
                if (data.hasOwnProperty("imageStr")) {
                    var imgData = "data:image/png;base64,";
                    imgData = imgData + data.imageStr;
                    $("#forgetpassword-verificationCode-image").attr("src", imgData);
                    $("#forgetpassword-verificationCode-image").data("valueImg", data.value)

                }
            },
            error: function (data) {
                alert("网络异常");
            }
        });
    }

    //获取短信验证码
    function signCodeNumber() {
        var strCodeValue = $("#forgetpassword-verificationCode-image").data("valueImg");
        var strUrl = "type=1&mobileNumber=" + $("#forgetpassword-writePhone").val() + "&identifyingCode=" + strCodeValue + "&deviceId=" + $("#forgetpassword-verificationCode-image").data("valueDeviceId");
        var url = "https://app.travelzen.com/tops-openapi-for-customers/mobileLogin/verificationCode?";
        if (isOp3 == 1)
        {
            url = "http://192.168.161.137:8480/mobileLogin/verificationCode?";
        }
        url = url + strUrl;
        $.ajax({
            url: url,
            dataType: 'json',
            type: 'post',
            contentType: "application/json;utf-8",
            success: function (data) {
                if(data.result == "FAIL")
                {
                    alert(data.errInfo);
                }
                else
                {
                    var countdown = 60;
                    timerOut(countdown);
                }
            },
            error: function (data) {

            }
        });
    }

    //倒计时
    function timerOut(countdown)
    {
        if (countdown == 0) {
            $("#forgetpassword-phone-code").text('获取验证码');
            countdown = 60;
        } else {
            $("#forgetpassword-phone-code").text("重新发送(" + countdown + "s)");
            countdown--;
        }setTimeout(function() {
        if (countdown != 60) {
            timerOut(countdown)
        }
    },1000)
    }

    //重置密码
    function registerAction() {

        if (!safevalid()) {
            return;
        }

        var phoneCode = $("#forgetpassword-input-code").val();
        if (phoneCode.length <= 0) {
            alert("请输入短信验证码");
            return;
        }

        var routeDetail = {};
        routeDetail.deviceId = $("#forgetpassword-verificationCode-image").data("valueDeviceId");
        routeDetail.identifyingCode = $("#forgetpassword-verificationCode-text").val();
        routeDetail.mobileNumber = $("#forgetpassword-writePhone").val();
        routeDetail.verificationCode = $("#forgetpassword-input-code").val();

        var dataRequest = {};
        dataRequest.requestMetaInfo = requestData();
        dataRequest.AppResetPasswordRequest = routeDetail;


        var url = "https://app.travelzen.com/tops-openapi-for-customers/service/flight/register";
        if (isOp3 == 1)
        {
            url = "http://192.168.161.137:8480/service/flight/register";
        }
        $.ajax({
            url: url,
            dataType: 'json',
            data: JSON.stringify(dataRequest),
            type: 'post',
            contentType: "application/json;utf-8",
            success: function (data) {
                if(data.responseMetaInfo.resultCode == 0)
                {
                    if (data.AppResetPasswordResponse.result == "FAIL")
                    {
                        alert(data.AppResetPasswordResponse.errInfo);
                    }
                    else
                    {
                        var storage = window.localStorage;
                        //手机号码
                        storage.forgetPasswordPhonelink = $("#forgetpassword-writePhone").val();
                        //重置密码key
                        storage.forgetPasswordCodelink = data.AppResetPasswordResponse.key;

                        window.location.href = "reset-password.html"
                    }
                }
                else
                {
                    alert(data.responseMetaInfo.reason);
                }
            },
            error: function (data) {
                alert("网络异常");
            }
        });
    }
</script>


</body>

</html>